<!-- SEARCH SECTION -->
<mat-card
  class="mm-card"
  style="max-width: 450px; margin: 0 auto 20px auto;"
>
  <!-- card title -->
  <div class="mm-card-title" style="text-align:center;">
    Search Stock News
  </div>

  <!-- centered search input area -->
  <div style="display:flex; flex-direction:column; align-items:center;">

    <!-- ticker input field -->
    <mat-form-field
      appearance="outline"
      style="width: 320px; max-width: 90%;"
    >
      <mat-label>Ticker Symbol (e.g., AAPL)</mat-label>
      <input
        matInput
        [(ngModel)]="query"
        placeholder="Enter a ticker"
        (keyup.enter)="search()" 
      />
    </mat-form-field>

    <!-- search button -->
    <button
      mat-raised-button
      color="primary"
      style="width: 200px; margin-top: 10px;"
      (click)="search()"
    >
      Search
    </button>

  </div>
</mat-card>

<!-- error message for invalid ticker -->
<mat-card *ngIf="searchError" class="mm-card" style="margin-top: 25px; color: #b20000; font-weight: 600;">
  {{ searchError }}
</mat-card>

<!-- watchlist header shown only when no search results -->
<div *ngIf="!latest && !sentiment" class="mm-card-title" style="margin-top: 30px;">
  Your Watchlist
</div>

<!-- watchlist item grid -->
<div class="watchlist-grid" *ngIf="!latest && !sentiment">
  <mat-card
    class="mm-card"
    *ngFor="let item of watchlist"
    (click)="openTicker(item.ticker)"
    style="cursor: pointer;"
  >
    <!-- ticker display -->
    <div class="watchlist-ticker">{{ item.ticker }}</div>

    <!-- price display -->
    <div class="watchlist-price">
      {{ item.price ? ('$' + item.price.toFixed(2)) : '—' }}
    </div>

    <!-- sentiment header -->
    <div class="mm-card-subtitle">Last 20 Sentiments:</div>

    <!-- sentiment counts -->
    <div>
      <div class="sent-pos">Positive: {{ item.sentiment?.positive }}</div>
      <div class="sent-neutral">Neutral: {{ item.sentiment?.neutral }}</div>
      <div class="sent-neg">Negative: {{ item.sentiment?.negative }}</div>
    </div>

    <!-- latest article preview -->
    <div class="latest-article" *ngIf="item.latest">
      <strong>Latest:</strong> <br />
      {{ item.latest.title }}
    </div>
  </mat-card>
</div>

<!-- search results card -->
<mat-card
  *ngIf="latest || sentiment"
  class="mm-card"
  style="position: relative; cursor: pointer;"
  (click)="openTicker(query.toUpperCase())"
>

  <!-- close search button -->
  <button
    mat-icon-button
    (click)="clearSearch(); $event.stopPropagation()"
    style="position: absolute; top: 8px; right: 8px;"
    aria-label="Close search result"
  >
    X
  </button>

  <!-- search result ticker title -->
  <div class="mm-card-title">
    {{ query.toUpperCase() }}
  </div>

  <!-- sentiment summary -->
  <div class="mm-card-subtitle">Last 20 News Sentiments:</div>

  <div style="margin-bottom: 12px;">
    <span class="sent-pos">Positive: {{ sentiment?.positive }}</span> •
    <span class="sent-neutral">Neutral: {{ sentiment?.neutral }}</span> •
    <span class="sent-neg">Negative: {{ sentiment?.negative }}</span>
  </div>

  <!-- latest article block -->
  <div class="article-card" *ngIf="latest">
    <div class="article-title">{{ latest.title }}</div>

    <!-- article metadata -->
    <div class="article-meta">
      {{ latest.published_utc | date:'short' }} •
      <span
        [ngClass]="{
          'sent-pos': latest.insights?.[0]?.sentiment === 'positive',
          'sent-neutral': latest.insights?.[0]?.sentiment === 'neutral',
          'sent-neg': latest.insights?.[0]?.sentiment === 'negative'
        }"
      >
        {{ latest.insights?.[0]?.sentiment | titlecase }}
      </span>
    </div>

    <!-- external article link -->
    <a
      [href]="latest.article_url"
      target="_blank"
      (click)="$event.stopPropagation()"
    >
      Read Article
    </a>

    <!-- add to watchlist button -->
    <button
      mat-button
      color="accent"
      style="margin-top: 12px;"
      (click)="addToWatchlist(query.toUpperCase()); $event.stopPropagation()"
    >
      Add to Watchlist
    </button>
  </div>

</mat-card>
